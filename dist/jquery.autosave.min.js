var Autosave=Autosave||{};Autosave.storageName="autosave",Autosave.formClass=".autosave-form",Autosave.formAttr="data-autosave",Autosave.onPage=!1,Autosave.msgExit="Возможно, внесенные изменения не сохранятся.",Autosave._setItem=function(t){var e=Autosave._getFullItem(),o=$(t).closest("form").attr(Autosave.formAttr),a=$(t).index(),s=!1,u=t.value;$.each(e,function(t,e){e.id==o&&e.i==a&&(e.text=u,e.reset=!1,s=!0)}),s||e.push({id:o,i:a,text:u,reset:!1}),Autosave.onPage=""!=u,window.localStorage.setItem(Autosave.storageName,JSON.stringify(e))},Autosave._getFullItem=function(){return JSON.parse(window.localStorage.getItem(Autosave.storageName))||[]},Autosave._getText=function(t,e){var o=$(t).closest("form").attr(Autosave.formAttr),a=$(t).index(),s="";return $.each(Autosave._getFullItem(),function(t,u){if(u.id==o&&u.i==a&&(e&&0==u.reset||!e))return void(s=u.text)}),s},Autosave.bind=function(t){if(90==t.keyCode&&t.ctrlKey){if(""!=this.value)return!0;this.value=Autosave._getText(this,!1),Autosave._setItem(this)}else t.ctrlKey||Autosave._setItem(this)},Autosave.restore=function(){if(""==this.value){var t=Autosave._getText(this,!0);this.value=t,Autosave.onPage=""!=t}},Autosave.reset=function(){var t=Autosave._getFullItem(),e=$(this).closest("form").attr(Autosave.formAttr);$.each(t,function(t,o){o.id==e&&(o.reset=!0,Autosave.onPage=!1)}),window.localStorage.setItem(Autosave.storageName,JSON.stringify(t))},Autosave.remove=function(t){var e=Autosave._getFullItem(),o=$(t).attr(Autosave.formAttr);$.each(e,function(t,a){if(a&&a.id==o){var s=e.indexOf(a);s>-1&&e.splice(s,1),Autosave.onPage=!1}}),window.localStorage.setItem(Autosave.storageName,JSON.stringify(e))},Autosave.exitAjax=function(){return!!Autosave.onPage&&(!confirm(Autosave.msgExit)||(Autosave.onPage=!1,!1))},$(document).on("keyup",Autosave.formClass+" textarea",Autosave.bind),$(document).on("reset",Autosave.formClass,Autosave.reset),$(function(){$(Autosave.formClass).has(":visible").find("textarea").each(Autosave.restore)}),$(window).on("beforeunload",function(){if(Autosave.onPage)return Autosave.msgExit});